<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> è‹±è¯­è¿›é˜¶ | Dictation & Translation</title>
    <!-- å¼•å…¥ Diff åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <!-- å¼•å…¥ XLSX åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- åŸºç¡€è®¾ç½® & å“åº”å¼é€‚é… --- */
        :root {
            --primary: #4f46e5; /* å­¦ä¹ è“ */
            --primary-hover: #4338ca;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --error: #ef4444;
            --radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- å¤´éƒ¨ & å¯¼èˆª --- */
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 { font-size: 1.8rem; color: var(--text-main); margin-bottom: 10px; }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            background: #e5e7eb;
            padding: 5px;
            border-radius: 50px;
            max-width: 400px;
            margin: 0 auto;
        }
        .nav-tabs button {
            flex: 1;
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 45px;
            font-weight: 600;
            color: var(--text-sub);
            transition: all 0.3s ease;
        }
        .nav-tabs button.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- é€šç”¨å¡ç‰‡æ ·å¼ --- */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        
        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        /* --- è¡¨å•æ§ä»¶ --- */
        select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px; /* é˜²æ­¢æ‰‹æœºç«¯è‡ªåŠ¨æ”¾å¤§ */
            box-sizing: border-box;
            font-family: inherit;
            resize: vertical;
        }
        select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* --- æŒ‰é’®æ ·å¼ --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: 0.2s;
            font-size: 0.95rem;
        }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-check { background: var(--text-main); color: white; margin-top: 10px; width: auto; padding: 8px 16px; font-size: 0.9rem;}
        
        /* æ‰‹æœºç«¯æŒ‰é’®é€‚é… */
        @media (max-width: 600px) {
            .btn-group { flex-direction: column; gap: 10px; }
            .btn { width: 100%; }
        }

        /* --- å¬å†™ & ç¿»è¯‘ç‰¹å®š --- */
        .audio-player { width: 100%; margin: 10px 0; height: 40px; }
        
        .diff-result {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
        }
        .diff-del { background-color: #fee2e2; text-decoration: line-through; color: #991b1b; }
        .diff-ins { background-color: #dcfce7; color: #166534; font-weight: bold; }
        
        .analysis-tag {
            display: inline-block;
            background: #fff7ed;
            color: #c2410c;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 8px;
            border: 1px solid #ffedd5;
        }

        /* --- PDF æ¨¡æ€æ¡† --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto; 
            padding: 0;
            border-radius: 12px;
            width: 90%; 
            max-width: 1000px;
            height: 90%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .close-modal { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .pdf-frame { flex: 1; border: none; width: 100%; height: 100%; }

        /* åŠ¨ç”» */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“š è‹±æ–‡ç²¾è¿›å·¥å…·ç®±</h1>
        <div class="nav-tabs">
            <button onclick="switchTab('dictation')" id="btn-dictation" class="active">ğŸ§ å¬å†™è®­ç»ƒ</button>
            <button onclick="switchTab('translation')" id="btn-translation">ğŸ” å›è¯‘è®­ç»ƒ</button>
        </div>
    </header>

    <!-- ================= å¬å†™æ¨¡å— ================= -->
    <div id="dictation" class="section active">
        <div class="control-panel">
            <label style="font-weight:bold; display:block; margin-bottom:8px;">é€‰æ‹©è¯¾ç¨‹</label>
            <select id="dictation-select" onchange="loadDictationLesson()">
                <option value="">-- è¯·é€‰æ‹©å¬å†™ææ–™ --</option>
            </select>
        </div>

        <div id="dictation-workspace" style="display:none;">
            <div class="card" style="text-align: center; background: #e0e7ff; border:none;">
                <h3 style="margin:0 0 10px 0; color: var(--primary);">Step 1: å®Œæ•´ç£¨è€³æœµ</h3>
                <audio id="full-audio" controls class="audio-player"></audio>
            </div>
            <div id="sentence-container"></div>
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-primary" onclick="exportDictationExcel()" style="padding: 15px 30px; font-size: 1.1rem;">
                    ğŸ“Š å®Œæˆç»ƒä¹ å¹¶å¯¼å‡ºæŠ¥å‘Š
                </button>
            </div>
        </div>
    </div>

    <!-- ================= å›è¯‘æ¨¡å— ================= -->
    <div id="translation" class="section">
        <div class="control-panel">
            <label style="font-weight:bold; display:block; margin-bottom:8px;">é€‰æ‹©è¯­æ–™</label>
            <select id="trans-select" onchange="loadTransLesson()">
                <option value="">-- è¯·é€‰æ‹©å›è¯‘ææ–™ --</option>
            </select>
            
            <div style="margin-top: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 15px;">
                    <label style="cursor:pointer; display:flex; align-items:center;">
                        <input type="radio" name="order" value="seq" checked> é¡ºåºç»ƒä¹ 
                    </label>
                    <label style="cursor:pointer; display:flex; align-items:center;">
                        <input type="radio" name="order" value="random"> ä¹±åºç»ƒä¹ 
                    </label>
                </div>
                
                <div style="flex:1; text-align: right; min-width: 200px;">
                    <button class="btn btn-secondary" onclick="openPdfModal()">ğŸ“„ æŸ¥çœ‹åŸæ–‡ PDF</button>
                    <button class="btn btn-primary" onclick="startTransPractice()" style="width: auto; margin-left: 10px;">ğŸš€ å¼€å§‹ç»ƒä¹ </button>
                </div>
            </div>
        </div>

        <div id="trans-workspace" style="display:none;">
            <div id="trans-cards"></div>
             <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-primary" onclick="exportTransExcel()" style="padding: 15px 30px; font-size: 1.1rem;">
                    ğŸ“Š å®Œæˆç»ƒä¹ å¹¶å¯¼å‡ºæŠ¥å‘Š
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PDF æ¨¡æ€æ¡† -->
<div id="pdfModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-weight:bold; font-size:1.1rem;">åŸæ–‡é¢„è§ˆ</span>
            <span class="close-modal" onclick="closePdfModal()">&times;</span>
        </div>
        <iframe id="pdf-iframe" class="pdf-frame" src=""></iframe>
        <div style="padding:10px; text-align:center; background:#f9f9f9; font-size:0.9rem; color:#666;">
            å¦‚æœæ— æ³•é¢„è§ˆï¼Œè¯· <a id="pdf-download-link" href="#" target="_blank" download="original_text.pdf">ç‚¹å‡»è¿™é‡Œä¸‹è½½ PDF</a>
        </div>
    </div>
</div>

<script>
    // --- æ•°æ®ä¸çŠ¶æ€ ---
    // appData å°†ä»å¤–éƒ¨æ–‡ä»¶åŠ è½½ï¼Œå…ˆå£°æ˜ä¸ºç©ºå¯¹è±¡
    let appData = {};
    let currentDictation = null;
    let currentTrans = null;
    let userDictationInputs = {};
    let userTransInputs = {};

    // --- åˆå§‹åŒ– ---
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¼‚æ­¥è·å–æ•°æ®
    window.onload = async function() {
        try {
            // ä½¿ç”¨ fetch API ä»æœåŠ¡å™¨è·å– data.json æ–‡ä»¶
            const response = await fetch('data.json');
            // å¦‚æœç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // å°†è¿”å›çš„ JSON æ–‡æœ¬è§£æä¸º JavaScript å¯¹è±¡
            appData = await response.json();
            
            // æ•°æ®åŠ è½½æˆåŠŸåï¼Œæ‰åˆå§‹åŒ–ä¸‹æ‹‰èœå•
            initMenus();
        } catch (e) {
            console.error("Data loading failed:", e);
            alert("è¯¾ç¨‹æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ data.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚");
        }
    };

    function initMenus() {
        const dSelect = document.getElementById('dictation-select');
        appData.dictation.forEach((d, index) => dSelect.innerHTML += `<option value="${index}">${d.title}</option>`);
        const tSelect = document.getElementById('trans-select');
        appData.translation.forEach((t, index) => tSelect.innerHTML += `<option value="${index}">${t.title}</option>`);
    }

    function switchTab(tab) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
        document.getElementById('btn-' + tab).classList.add('active');
    }

    // --- å¬å†™é€»è¾‘ ---
    function loadDictationLesson() {
        const index = document.getElementById('dictation-select').value;
        if (index === "") {
            document.getElementById('dictation-workspace').style.display = 'none';
            return;
        }
        
        currentDictation = appData.dictation[index];
        document.getElementById('dictation-workspace').style.display = 'block';
        document.getElementById('full-audio').src = currentDictation.fullAudio;
        
        const container = document.getElementById('sentence-container');
        container.innerHTML = '';
        userDictationInputs = {};

        currentDictation.sentences.forEach((s, idx) => {
            const html = `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="font-weight:bold; color:var(--text-sub);">Sentence ${idx + 1}</span>
                    </div>
                    <audio controls src="${s.audio}" class="audio-player"></audio>
                    <textarea id="d-input-${idx}" rows="2" placeholder="å¬å½•éŸ³ï¼Œå†™ä¸‹å¥å­..."></textarea>
                    <div style="text-align:right;">
                        <button class="btn btn-check" onclick="checkDictation(${idx})">âœ… æäº¤æ£€æŸ¥</button>
                    </div>
                    <div id="d-result-${idx}" style="display:none;"></div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function checkDictation(idx) {
        const inputEl = document.getElementById(`d-input-${idx}`);
        const input = inputEl.value.trim();
        const original = currentDictation.sentences[idx].en;
        const resultDiv = document.getElementById(`d-result-${idx}`);
        
        userDictationInputs[idx] = input;

        if (!input) return alert("è¯·å…ˆè¾“å…¥å†…å®¹");

        const dmp = new diff_match_patch();
        const diffs = dmp.diff_main(input, original);
        dmp.diff_cleanupSemantic(diffs);
        
        let html = '';
        let hasError = false;
        diffs.forEach(part => {
            if (part[0] === 0) html += `<span>${part[1]}</span>`;
            else if (part[0] === -1) { html += `<span class="diff-del">${part[1]}</span>`; hasError = true; }
            else { html += `<span class="diff-ins">${part[1]}</span>`; hasError = true; }
        });

        let analysis = hasError ? "ğŸ’¡ æç¤ºï¼šæ³¨æ„æ‹¼å†™æˆ–è¿è¯»ç»†èŠ‚ã€‚" : "ğŸ‰ å®Œç¾æ­£ç¡®ï¼";

        resultDiv.innerHTML = `
            <div class="diff-result">
                <div style="margin-bottom:5px;"><strong>ä½ çš„å¬å†™å¯¹æ¯”ï¼š</strong></div>
                <div>${html}</div>
                <div style="margin-top:10px; color:#666; font-size:0.9em;">åŸæ–‡ï¼š${original}</div>
                <div style="color:#666; font-size:0.9em;">è¯‘æ–‡ï¼š${currentDictation.sentences[idx].cn}</div>
                <div class="analysis-tag">${analysis}</div>
            </div>
        `;
        resultDiv.style.display = 'block';
    }

    function exportDictationExcel() {
        if (!currentDictation) return;
        const data = currentDictation.sentences.map((s, idx) => ({
            "Index": idx + 1,
            "Original Text": s.en,
            "Chinese Meaning": s.cn,
            "My Input": userDictationInputs[idx] || "(æœªå¡«å†™)"
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dictation Result");
        XLSX.writeFile(wb, `Dictation_${currentDictation.title}.xlsx`);
    }

    // --- å›è¯‘é€»è¾‘ ---
    function loadTransLesson() {
        const index = document.getElementById('trans-select').value;
        if (index !== "") {
            currentTrans = appData.translation[index];
            document.getElementById('trans-workspace').style.display = 'none';
        } else {
            currentTrans = null;
        }
    }

    // =======================================================
    // å…³é”®ä¿®æ”¹ï¼šä¿®æ­£ PDF è·¯å¾„é€»è¾‘
    // =======================================================
    function openPdfModal() {
        if (!currentTrans) return alert("è¯·å…ˆé€‰æ‹©è¯­æ–™ã€‚");

        // 1. ä¼˜å…ˆå°è¯•ä» data.json è¯»å– 'pdf' å­—æ®µ
        // 2. å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°è¯•ä½¿ç”¨ 'files/' + æ ‡é¢˜ + '.pdf' çš„æ–¹å¼æ‹¼æ¥
        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† encodeURIComponent æ¥å¤„ç†ä¸­æ–‡æ–‡ä»¶å
        let pdfPath = "";
        
        if (currentTrans.pdf) {
             // å¦‚æœ JSON é‡Œå†™äº† "pdf": "files/abc.pdf" æˆ– "pdf": "http..."
             pdfPath = currentTrans.pdf;
        } else {
             // å¦‚æœ JSON é‡Œæ²¡å†™ pdf è·¯å¾„ï¼Œæˆ‘ä»¬é»˜è®¤å» files æ–‡ä»¶å¤¹æ‰¾åŒåæ–‡ä»¶
             // ä¾‹å¦‚æ ‡é¢˜æ˜¯ "Lesson1"ï¼Œåˆ™å»æ‰¾ "files/Lesson1.pdf"
             pdfPath = "files/" + currentTrans.title + ".pdf";
        }

        // è°ƒè¯•ï¼šåœ¨æ§åˆ¶å°æ‰“å°è·¯å¾„ï¼Œå¦‚æœè¿˜æ‰“ä¸å¼€ï¼ŒæŒ‰ F12 çœ‹ Console é‡Œçš„è¿™ä¸ªè·¯å¾„å¯¹ä¸å¯¹
        console.log("æ­£åœ¨å°è¯•æ‰“å¼€ PDF:", pdfPath);

        document.getElementById('pdf-iframe').src = pdfPath;
        document.getElementById('pdf-download-link').href = pdfPath;
        document.getElementById('pdfModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closePdfModal() {
        document.getElementById('pdfModal').style.display = 'none';
        document.getElementById('pdf-iframe').src = "";
        document.body.style.overflow = 'auto';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('pdfModal');
        if (event.target == modal) closePdfModal();
    }

    function startTransPractice() {
        if (!currentTrans) return alert("è¯·å…ˆé€‰æ‹©è¯­æ–™");
        
        const order = document.querySelector('input[name="order"]:checked').value;
        let pairs = [...currentTrans.pairs];
        if (order === 'random') pairs.sort(() => Math.random() - 0.5);

        const container = document.getElementById('trans-cards');
        container.innerHTML = '';
        userTransInputs = {};
        document.getElementById('trans-workspace').style.display = 'block';

        pairs.forEach((p, index) => {
            const html = `
                <div class="card">
                    <div style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">${index + 1}. ${p.cn}</div>
                    <textarea id="t-input-${p.id}" rows="3" placeholder="è¯·è¾“å…¥è‹±æ–‡ç¿»è¯‘..."></textarea>
                    <div style="text-align:right;">
                        <button class="btn btn-check" onclick="checkTranslation(${p.id}, '${p.en.replace(/'/g, "\\'")}')">âœ… æäº¤æ£€æŸ¥</button>
                    </div>
                    <div id="t-result-${p.id}" style="display:none;"></div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function checkTranslation(id, original) {
        const inputEl = document.getElementById(`t-input-${id}`);
        const input = inputEl.value.trim();
        const resultDiv = document.getElementById(`t-result-${id}`);
        
        userTransInputs[id] = input;

        const dmp = new diff_match_patch();
        const diffs = dmp.diff_main(input, original);
        dmp.diff_cleanupSemantic(diffs);
        
        let html = '';
        diffs.forEach(part => {
            if (part[0] === 0) html += `<span>${part[1]}</span>`;
            else if (part[0] === -1) html += `<span class="diff-del">${part[1]}</span>`;
            else html += `<span class="diff-ins">${part[1]}</span>`;
        });

        resultDiv.innerHTML = `
            <div class="diff-result">
                <div style="margin-bottom:5px;"><strong>æ‰¹æ”¹ç»“æœï¼š</strong></div>
                <div>${html}</div>
                <div style="margin-top:10px; color:#666;"><strong>å‚è€ƒç­”æ¡ˆï¼š</strong> ${original}</div>
            </div>
        `;
        resultDiv.style.display = 'block';
    }

    function exportTransExcel() {
        if (!currentTrans) return;
        const data = currentTrans.pairs.map(p => ({
            "Chinese": p.cn,
            "My Translation": userTransInputs[p.id] || "(æœªå¡«å†™)",
            "Correct Answer": p.en
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Translation Result");
        XLSX.writeFile(wb, `Translation_${currentTrans.title}.xlsx`);
    }
</script>

</body>
</html>
